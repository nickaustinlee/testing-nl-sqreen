'use strict';
const INTERFACES = require('../enums').INTERFACES;
const TRANSPORT = require('../enums').TRANSPORT;
const Transports = require('../transports');

module.exports = function (payload, ecoSystemInterface) {

    const request = payload.request;
    if (request !== 'kafka-node') {
        return;
    }

    const module = payload.module;

    const transport = ecoSystemInterface.getInterface(INTERFACES.TRANSPORT);
    const instrumentation = ecoSystemInterface.getInterface(INTERFACES.INSTRUMENTATION);

    const getHook = function (server, listener) {

        let host = '';
        try {
            host = server.client.options.kafkaHost;
        }
        catch (_) {}
        if (host.indexOf(':') > -1) {
            host = host.split(':')[0];
        }

        return function (message) {

            transport.startIncomingTransaction(message, (session, budget) => { // TODO: abstract in agent

                budget.startCount();

                try {
                    const todo = transport.shouldPropagate(TRANSPORT.SCOPE.PRODUCER);
                    const trigger = todo.trigger;
                    const fields = todo.fields;

                    if (fields.length !== 0) {
                        const resolved = new Transports.ConsumerTransport();
                        resolved.addMessageType(fields, TRANSPORT.TRANSPORT_TYPE.KAFKA);
                        if (fields.indexOf('host') > -1) {
                            resolved.host = host;
                        }
                        resolved.addTA(fields, ecoSystemInterface);
                        resolved.addIP(fields, host);

                        if (fields.indexOf('topic') > -1) {
                            resolved.topic = message.topic;
                        }
                        transport.propagate(resolved, trigger); // Cleanup will never be called in that case :thinking:
                    }
                }
                catch (_) {}
                budget.stopCount();
                return listener.apply(this, arguments);

            });
        };
    };

    instrumentation.strategies.patchEventListeners(module.Consumer.prototype, 'message', getHook);

};
