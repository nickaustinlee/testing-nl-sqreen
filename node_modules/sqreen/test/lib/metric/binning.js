/**
 * Copyright (c) 2016 - 2020 Sqreen. All Rights Reserved.
 * Please refer to our terms for more information: https://www.sqreen.io/terms.html
 */
'use strict';
const Code = require('code');
const Lab = require('lab');
const lab = exports.lab = Lab.script();
const beforeEach = lab.beforeEach;

const describe = lab.describe;
const it = lab.it;
const expect = Code.expect;

const Metric = require('../../../lib/metric');
const Binning = require('../../../lib/metric/binning');

const SqreenSDK = require('sqreen-sdk');

describe('Metric', () => {

    beforeEach((done) => {

        Metric._clearAllMetrics();
        SqreenSDK.initBatch(100000, 10000, () => Promise.resolve());
        require('../../../lib/command/features').featureHolder.use_signals = true;
        done();
    });

    describe('Binning', () => {

        it('should create a binning metric', { plan: 7, timeout: 20000 }, (done) => {

            const metric = new Binning({
                kind: 'Binning',
                name: 'bin-stuff',
                period: 2.5
            }, { base: 2, factor: 0.1 });

            const now = new Date();
            metric.add(150, now);
            metric.add(-10, now);
            metric.add(110.8946, now);
            metric.add(250, now);
            metric.add(192, now);

            expect(Metric.getMetricByName('bin-stuff')).to.equal(metric);
            setTimeout(() => {

                const then = new Date();
                metric.add(195, then);
                metric.add(154, then);
            }, 3000);

            setTimeout(() => {

                Metric.getAllReports(true);
                const metricList = SqreenSDK.Signal.prototype.BATCH.data;
                expect(metricList[0].payload.max).to.equal(250);
                expect(metricList[0].payload.bins).to.equal({ 12: 3, 13: 1, 1: 1, max: undefined });
                expect(metricList[0].payload.unit).to.equal(0.1);
                expect(metricList[0].payload.base).to.equal(2);

                expect(metricList[1].payload.max).to.equal(195);
                expect(metricList[1].payload.bins).to.equal({ 12: 2, max: undefined });

                done();
            }, 6000);

        });

        it('should create a binning metric like in Java', { plan: 4, timeout: 20000 }, (done) => {

            const metric = new Binning({
                kind: 'Binning',
                name: 'bin-java-stuff',
                period: 1.0
            }, { base: 2.0, factor: 1.0 });

            const now = new Date();

            metric.add(1.0, now);
            metric.add(0.2, now);
            metric.add(2.2, now);
            metric.add(2.0, now);
            metric.add(-0.0, now);

            setTimeout(() => {

                Metric.getAllReports(true);
                const metricList = SqreenSDK.Signal.prototype.BATCH.data;
                expect(metricList[0].payload.max).to.equal(2.2);
                expect(metricList[0].payload.bins).to.equal({ 1: 2, 2: 1, 3: 2, max: undefined });
                expect(metricList[0].payload.unit).to.equal(1);
                expect(metricList[0].payload.base).to.equal(2);

                done();
            }, 1100);

        });

    });
});
